env:
  LC_ALL: "C.UTF-8"
  NIX_PATH: "channel:nixos-21.11"

steps:
  - label: 'Check auto-generated Nix on macos'
    key: macos-nix
    commands:
      - 'cat /Users/anviking/fake-secret'
      - './nix/regenerate.sh'
    agents:
      queue: hal-mac

  # ADP-2522 - Fix integration tests on MacOS
  - label: 'Run integration tests on macos'
    depends_on: macos-nix
    command: 'arch=aarch64 GC_DONT_GC=1 nix build -L .#ci.x86_64-darwin.tests.run.integration'
    agents:
      queue: hal-mac
